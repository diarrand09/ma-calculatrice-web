name: ðŸš€ DÃ©ploiement Continu

# Se dÃ©clenche seulement quand le code est pushÃ© sur main
# ET que les tests CI passent
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # DÃ©ploiement manuel

# Permissions nÃ©cessaires pour GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Variables d'environnement
env:
  NODE_VERSION: '18'

jobs:
  # Job 1 : Construction du projet
  build:
    name: ðŸ—ï¸ Construction
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout du code
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ðŸ§ª Tests prÃ©alables
      run: |
        echo "ðŸ” VÃ©rification avant dÃ©ploiement..."
        npm test
        echo "âœ… Tous les tests passent"
    
    - name: ðŸ—ï¸ Build du projet
      run: |
        echo "ðŸ”¨ Construction du projet pour la production..."
        mkdir -p dist
        cp index.html dist/
        cp -r css dist/
        cp -r js dist/
        cp -r tests dist/
        echo "âœ… Build terminÃ©"
    
    - name: ðŸ“„ GÃ©nÃ©ration des mÃ©tadonnÃ©es
      run: |
        echo "ðŸ“Š GÃ©nÃ©ration des informations de build..."
        cat > dist/build-info.json << EOF
        {
          "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "author": "${{ github.actor }}",
          "repository": "${{ github.repository }}"
        }
        EOF
        echo "âœ… MÃ©tadonnÃ©es gÃ©nÃ©rÃ©es"
    
    - name: ðŸ“¤ Upload des artefacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  # Job 2 : DÃ©ploiement sur GitHub Pages
  deploy:
    name: ðŸŒ DÃ©ploiement GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸš€ DÃ©ploiement sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ðŸŽ‰ Confirmation de dÃ©ploiement
      run: |
        echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi !"
        echo "ðŸ”— URL : ${{ steps.deployment.outputs.page_url }}"

  # Job 3 : Notifications
  notification:
    name: ðŸ“§ Notifications
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: ðŸ“¨ Notification de succÃ¨s
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… === DÃ‰PLOIEMENT RÃ‰USSI ==="
        echo "ðŸŽ¯ Projet : ${{ github.repository }}"
        echo "ðŸš€ Branche : ${{ github.ref_name }}"
        echo "ðŸ‘¤ Auteur : ${{ github.actor }}"
        echo "ðŸ“… Date : $(date)"
        echo "ðŸ”— Commit : ${{ github.sha }}"
    
    - name: âŒ Notification d'Ã©chec
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ === DÃ‰PLOIEMENT Ã‰CHOUÃ‰ ==="
        echo "ðŸŽ¯ Projet : ${{ github.repository }}"
        echo "ðŸ” VÃ©rifiez les logs pour plus de dÃ©tails"