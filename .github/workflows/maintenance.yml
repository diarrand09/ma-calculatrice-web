name: ğŸ”§ Maintenance Automatique

# Planification : tous les dimanche Ã  2h du matin UTC
on:
  schedule:
    - cron: '0 2 * * 0'  # Chaque dimanche Ã  2h (corrigÃ© : * * 0 au lieu de * *0)
  workflow_dispatch:  # ExÃ©cution manuelle

jobs:
  # Job 1 : VÃ©rifications de santÃ©
  health-check:
    name: ğŸ¥ VÃ©rification de SantÃ©
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ” VÃ©rification des liens morts
      run: |
        echo "ğŸ”— VÃ©rification des liens dans le README..."
        # VÃ©rifier si le README existe
        if [ -f README.md ]; then
          echo "âœ… README.md trouvÃ©"
          # Extraire les liens HTTP/HTTPS du README
          grep -oE 'https?://[^)]*' README.md || echo "â„¹ï¸ Aucun lien externe trouvÃ©"
        else
          echo "âš ï¸ README.md non trouvÃ©"
        fi
        echo "âœ… VÃ©rification des liens terminÃ©e"
    
    - name: ğŸ“Š Analyse de la taille du projet
      run: |
        echo "ğŸ“ Analyse de la taille du repository..."
        # Taille totale
        TOTAL_SIZE=$(du -sh . | cut -f1)
        echo "ğŸ’¾ Taille totale : $TOTAL_SIZE"
        
        # Nombre de fichiers par type
        echo "ğŸ“ Statistiques des fichiers :"
        echo "  - Total fichiers : $(find . -type f -not -path './.git/*' | wc -l)"
        echo "  - Fichiers JavaScript : $(find . -name "*.js" -not -path './.git/*' | wc -l)"
        echo "  - Fichiers CSS : $(find . -name "*.css" -not -path './.git/*' | wc -l)"
        echo "  - Fichiers HTML : $(find . -name "*.html" -not -path './.git/*' | wc -l)"
        
        # Top 5 des plus gros fichiers
        echo "ğŸ“‹ Top 5 des plus gros fichiers :"
        find . -type f -not -path './.git/*' -exec du -h {} + | sort -rh | head -5
    
    - name: ğŸ§¹ Nettoyage des fichiers temporaires
      run: |
        echo "ğŸ§¹ Nettoyage en cours..."
        
        # Compter avant nettoyage
        TEMP_FILES=$(find . -name "*.tmp" -o -name "*.log" -o -name "*~" -o -name ".DS_Store" | wc -l)
        echo "ğŸ“Š Fichiers temporaires trouvÃ©s : $TEMP_FILES"
        
        # Nettoyage
        find . -name "*.tmp" -delete
        find . -name "*.log" -delete  
        find . -name "*~" -delete
        find . -name ".DS_Store" -delete
        
        echo "âœ… Nettoyage terminÃ©"
    
    - name: ğŸ”’ VÃ©rification de sÃ©curitÃ© basique
      run: |
        echo "ğŸ”’ VÃ©rification de sÃ©curitÃ©..."
        
        # Chercher des patterns potentiellement dangereux
        echo "ğŸ” Recherche de secrets potentiels..."
        if grep -r -i "password\|secret\|api_key\|token" --include="*.js" --include="*.html" --include="*.css" . || true; then
          echo "âš ï¸ Patterns suspects trouvÃ©s (vÃ©rifiez manuellement)"
        else
          echo "âœ… Aucun pattern suspect dÃ©tectÃ©"
        fi
        
        # VÃ©rifier les permissions des fichiers
        echo "ğŸ” VÃ©rification des permissions..."
        find . -type f -perm /111 -not -path './.git/*' | head -10 || echo "âœ… Permissions normales"

  # Job 2 : Mise Ã  jour de la documentation
  update-docs:
    name: ğŸ“š Mise Ã  jour Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ Configuration Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ“ GÃ©nÃ©ration des statistiques
      run: |
        echo "ğŸ“Š GÃ©nÃ©ration des statistiques du projet..."
        
        # Compter les lignes de code de maniÃ¨re sÃ©curisÃ©e
        JS_LINES=0
        CSS_LINES=0
        HTML_LINES=0
        
        if [ -d "js" ]; then
          JS_LINES=$(find js -name "*.js" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        fi
        
        if [ -d "css" ]; then
          CSS_LINES=$(find css -name "*.css" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        fi
        
        HTML_FILES=$(find . -maxdepth 2 -name "*.html" | wc -l)
        if [ $HTML_FILES -gt 0 ]; then
          HTML_LINES=$(find . -maxdepth 2 -name "*.html" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        fi
        
        TOTAL_LINES=$((JS_LINES + CSS_LINES + HTML_LINES))
        
        echo "ğŸ“ˆ Statistiques du projet :"
        echo "  - JavaScript : $JS_LINES lignes"
        echo "  - CSS : $CSS_LINES lignes"  
        echo "  - HTML : $HTML_LINES lignes"
        echo "  - Total : $TOTAL_LINES lignes"
        
        # CrÃ©er un fichier de statistiques
        cat > STATS.md << EOF
        # ğŸ“Š Statistiques du Projet
        
        > DerniÃ¨re mise Ã  jour automatique : $(date -u "+%Y-%m-%d %H:%M:%S UTC")
        
        ## ğŸ“ Lignes de Code
        
        | Langage    | Lignes | Pourcentage |
        |------------|--------|-------------|
        | JavaScript | $JS_LINES | $([ $TOTAL_LINES -gt 0 ] && echo "$((JS_LINES * 100 / TOTAL_LINES))%" || echo "0%") |
        | CSS        | $CSS_LINES | $([ $TOTAL_LINES -gt 0 ] && echo "$((CSS_LINES * 100 / TOTAL_LINES))%" || echo "0%") |
        | HTML       | $HTML_LINES | $([ $TOTAL_LINES -gt 0 ] && echo "$((HTML_LINES * 100 / TOTAL_LINES))%" || echo "0%") |
        | **Total**  | **$TOTAL_LINES** | **100%** |
        
        ## ğŸ§ª Tests et QualitÃ©
        - âœ… Tests automatisÃ©s actifs
        - ğŸ”„ CI/CD fonctionnel
        - ğŸ”’ VÃ©rifications de sÃ©curitÃ© : OK
        
        ## ğŸ“Š MÃ©triques du Repository
        - ğŸ“ Nombre de fichiers : $(find . -type f -not -path './.git/*' | wc -l)
        - ğŸ’¾ Taille du projet : $(du -sh . | cut -f1)
        - ğŸ·ï¸ DerniÃ¨re maintenance : $(date -u "+%Y-%m-%d")
        
        ## ğŸš€ Statut des Services
        - GitHub Pages : âœ… DÃ©ployÃ©
        - Actions CI/CD : âœ… Fonctionnel
        - Tests automatiques : âœ… Passants
        
        ---
        *Rapport gÃ©nÃ©rÃ© automatiquement par GitHub Actions*
        EOF
        
        echo "âœ… Statistiques gÃ©nÃ©rÃ©es dans STATS.md"
    
    - name: ğŸ“‹ Mise Ã  jour du README avec badge de maintenance
      run: |
        echo "ğŸ“‹ Ajout du badge de maintenance..."
        if [ -f README.md ]; then
          # Ajouter un badge de derniÃ¨re maintenance si pas dÃ©jÃ  prÃ©sent
          if ! grep -q "Maintenance" README.md; then
            sed -i '1i ![Maintenance](https://img.shields.io/badge/Maintained-yes-green.svg)' README.md || true
            echo "âœ… Badge de maintenance ajoutÃ©"
          else
            echo "â„¹ï¸ Badge dÃ©jÃ  prÃ©sent"
          fi
        fi
    
    - name: ğŸ’¾ Commit des mises Ã  jour automatiques
      run: |
        # Configuration Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # VÃ©rifier s'il y a des changements
        if git diff --quiet && git diff --staged --quiet; then
          echo "â„¹ï¸ Aucun changement Ã  commiter"
        else
          git add STATS.md README.md 2>/dev/null || true
          git commit -m "ğŸ¤– Mise Ã  jour automatique de la documentation
          
          - Statistiques du projet mises Ã  jour
          - Badge de maintenance actualisÃ©
          - GÃ©nÃ©rÃ© le $(date -u '+%Y-%m-%d Ã  %H:%M UTC')" || echo "â„¹ï¸ Rien Ã  commiter"
          
          # Pousser les changements
          git push || echo "âš ï¸ Impossible de pousser les changements"
        fi

  # Job 3 : Rapport de maintenance
  maintenance-report:
    name: ğŸ“‹ Rapport de Maintenance
    runs-on: ubuntu-latest  
    needs: [health-check, update-docs]
    if: always()
    
    steps:
    - name: ğŸ“Š GÃ©nÃ©ration du rapport final
      run: |
        echo "ğŸ“‹ === RAPPORT DE MAINTENANCE HEBDOMADAIRE ==="
        echo "ğŸ“… Date : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”„ Workflow dÃ©clenchÃ© par : ${{ github.event_name }}"
        echo ""
        echo "ğŸ“Š RÃ©sultats des Jobs :"
        echo "ğŸ¥ Health Check : ${{ needs.health-check.result }}"
        echo "ğŸ“š Docs Update : ${{ needs.update-docs.result }}"
        echo ""
        
        # DÃ©terminer le statut global
        if [ "${{ needs.health-check.result }}" = "success" ] && [ "${{ needs.update-docs.result }}" = "success" ]; then
          echo "âœ… Maintenance terminÃ©e avec succÃ¨s"
          echo "ğŸ‰ Tous les systÃ¨mes sont opÃ©rationnels"
        else
          echo "âš ï¸ Maintenance terminÃ©e avec des avertissements"
          echo "ğŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
        fi
        
        echo ""
        echo "ğŸ“ˆ Prochaine maintenance prÃ©vue : Dimanche prochain Ã  2h UTC"
        echo "ğŸ”— Repository : ${{ github.repository }}"
        echo "ğŸ·ï¸ Commit : ${{ github.sha }}"
    
    - name: ğŸ“§ Notification en cas d'Ã©chec
      if: failure()
      run: |
        echo "ğŸš¨ ALERTE : La maintenance automatique a Ã©chouÃ© !"
        echo "ğŸ” Consultez les logs GitHub Actions pour diagnostiquer le problÃ¨me"
        echo "ğŸ“… Date de l'Ã©chec : $(date -u)"
        echo "ğŸ”— Lien vers les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"